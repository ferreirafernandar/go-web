# In this directory, run the following command to build this builder.
# $ gcloud builds submit . --config=cloudbuild.yaml
substitutions:
  _IMAGE_VERSION: 1.0.0
steps: 
  - id: "go_version"
    name: "gcr.io/cloud-builders/go"
    args: ["version"]
    env: ["GOPATH=."]
  - id: "go_test"
    name: "gcr.io/cloud-builders/go"
    args: ["test","./..."]
    env: ["GOPATH=."]

  - id: 'login docker hub'  
    name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: ['-c', 'docker login --username=$$USERNAME --password=$$PASSWORD']
    env:
      - name: username
        valueFrom:
          secretKeyRef:
            name: docker-credentials-secret
            key: username
      - name: password
        valueFrom:
          secretKeyRef:
            name: docker-credentials-secret
            key: password

  - id: 'build image docker'  
    name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: ['-c', 'docker build -t $$USERNAME/REPOSITORY:TAG .']
    env:
      - name: username
        valueFrom:
          secretKeyRef:
            name: docker-credentials-secret
            key: username
      - name: repository
        valueFrom:
          secretKeyRef:
            name: docker-credentials-secret
            key: repository 
      - name: tag
        valueFrom:
          secretKeyRef:
            name: docker-credentials-secret
            key: tag 


 - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: db-credentials-secret
                  key: password


  - id: 'push image docker'   
    name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: ['-c', 'docker push $$USERNAME/REPOSITORY:TAG']
    env:
      - name: username
        valueFrom:
          secretKeyRef:
            name: docker-credentials-secret
            key: username
      - name: repository
        valueFrom:
          secretKeyRef:
            name: docker-credentials-secret
            key: repository 
      - name: tag
        valueFrom:
          secretKeyRef:
            name: docker-credentials-secret
            key: tag 